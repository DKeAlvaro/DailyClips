<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Clips</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="wave-container">
        
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
    </div>
    <div class="page-container">

        <main class="main-content">
            <svg xmlns="http://www.w3.org/2000/svg" width="200" height="60" viewBox="0 0 400 120" class="active logo" id="animated-svg">
                <style>
                    .svg-elem-1 {
                        stroke-dashoffset: 541.9140625px;
                        stroke-dasharray: 541.9140625px;
                        -webkit-transition: stroke-dashoffset 1s cubic-bezier(0.47, 0, 0.745, 0.715) 0s;
                                transition: stroke-dashoffset 1s cubic-bezier(0.47, 0, 0.745, 0.715) 0s;
                    }
                    svg.active .svg-elem-1 {
                        stroke-dashoffset: 0;
                    }
                </style>
                <path d="M80 30a20 20 0 0 1 40 0v40a20 20 0 0 1-40 0v-30a10 10 0 0 1 20 0v30a5 5 0 0 0 10 0V30a20 20 0 0 0-40 0v40a30 30 0 0 0 60 0v-30" fill="none" stroke="#007bff" stroke-width="8" class="svg-elem-1"></path>
                <text x="150" y="75" font-family="Arial, sans-serif" font-size="48" fill="#ffff" font-weight="bold">DailyClips</text>
            </svg>
            <script>
                const svg = document.getElementById('animated-svg');
                svg.addEventListener('click', () => {
                    svg.classList.toggle('active');
                });
            </script>
            {% if video_path %}
            <div class="video-container">
                {% if current_index > 0 %}
                <a href="/?video={{ current_index - 1 }}" class="video-nav prev">
                    <span class="arrow">←</span>
                </a>
                {% endif %}

                {% if current_index < total_videos - 1 %}
                <a href="/?video={{ current_index + 1 }}" class="video-nav next">
                    <span class="arrow">→</span>
                </a>
                {% endif %}

                <video id="mainVideo" preload="metadata">
                    <source src="{{ url_for('static', filename=video_path) }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="controls desktop-controls">
                    <button class="play-pause-btn">Play</button>
                    <button class="record-btn" style="display: none;">Record</button>
                </div>
            </div>
            <div class="clip-legend">
                {% if video_title %}{{ video_title }}{% endif %}
            </div>
            <div class="svg-container">
                <img src="{{ url_for('static', filename='images/listen-then-repeat.svg') }}" alt="Listen then Repeat" class="floating-svg">
            </div>
            <div class="chart-container">
                <canvas id="accuracyChart"></canvas>
            </div>
            <div class="controls mobile-controls">
                <button class="play-pause-btn">Play</button>
                <button class="record-btn" style="display: none;">Record</button>
            </div>
            {% else %}
            <p>No video files found in the static/videos directory.</p>
            {% endif %}
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const subtitlesData = {{ subtitles|tojson|safe }};
        const savedScores = {{ saved_scores|tojson|safe }};
        
        // Initialize the accuracy chart
        const ctx = document.getElementById('accuracyChart').getContext('2d');

        // Create gradient for bars
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(74, 158, 255, 0.9)');    // Brighter at top
        gradient.addColorStop(0.5, 'rgba(74, 158, 255, 0.7)');  // Medium in middle
        gradient.addColorStop(1, 'rgba(74, 158, 255, 0.5)');    // Darker at bottom

        // Calculate initial score distribution
        const initialDistribution = Array(7).fill(0);
        let initialTotalScore = 0;
        
        if (savedScores && savedScores.length > 0) {
            savedScores.forEach(score => {
                const binIndex = Math.min(Math.floor(score / 15), 6);
                initialDistribution[binIndex]++;
                initialTotalScore += score;
            });
        }

        const initialAverageScore = savedScores.length > 0 ? 
            (initialTotalScore / savedScores.length).toFixed(1) + '%' : 
            'No scores yet';

        const accuracyChart = new Chart(ctx, {
            type: 'bar',
            data: {
            labels: ['0-15%', '16-30%', '31-45%', '46-60%', '61-75%', '76-90%', '91-100%'],
            datasets: [{
                    label: 'Global Scores',
                    data: initialDistribution,
                backgroundColor: Array(7).fill(gradient),
                borderColor: Array(7).fill('rgba(74, 158, 255, 0.9)'),
                borderWidth: 2,
                borderRadius: 5,
                barPercentage: 0.8
            }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: `Global Average Score: ${initialAverageScore}`,
                        color: '#fff',
                        font: {
                            family: 'Inter',
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    subtitle: {
                        display: false,
                        text: `Global Average: ${initialAverageScore}`,
                        color: '#fff',
                        font: {
                            family: 'Inter',
                            size: 14
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#fff',
                            font: {
                                family: 'Inter'
                            },
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            tickLength: 5,
                            drawTicks: true,
                            drawOnChartArea: true,
                            count: 5
                        }
                    },
                    x: {
                        ticks: {
                            color: '#fff',
                            font: {
                                family: 'Inter'
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Function to update chart with global scores
        function updateGlobalScores() {
            const videoIndex = window.location.search.split('=')[1] || '0';
            fetch(`/get_global_scores/${videoIndex}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reset data array
                        const scoreDistribution = Array(7).fill(0);
                        let totalScore = 0;
                        
                        // Calculate distribution and average
                        if (data.scores.length > 0) {
                            data.scores.forEach(score => {
                                const binIndex = Math.min(Math.floor(score / 15), 6);
                                scoreDistribution[binIndex]++;
                                totalScore += score;
                            });
                            
                            const averageScore = totalScore / data.scores.length;
                            accuracyChart.options.plugins.subtitle.text = `Global Average: ${averageScore.toFixed(1)}%`;
                        } else {
                            accuracyChart.options.plugins.subtitle.text = 'No scores yet';
                        }
                        
                        // Update chart data
                        accuracyChart.data.datasets[0].data = scoreDistribution;
                        accuracyChart.update();
                    }
                })
                .catch(error => {
                    console.error('Error fetching global scores:', error);
                    accuracyChart.options.plugins.subtitle.text = 'Error loading scores';
                    accuracyChart.update();
                });
        }

        // Update global scores every 30 seconds
        setInterval(updateGlobalScores, 30000);

        // Function to update chart with new score
        function updateAccuracyChart(newScore) {
            const binIndex = Math.min(Math.floor(newScore / 15), 6);
            accuracyChart.data.datasets[0].data[binIndex]++;
            accuracyChart.update();
            // Update global scores to show latest data
            updateGlobalScores();
        }
    </script>
    <script src="{{ url_for('static', filename='js/asr-client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/video-controls.js') }}"></script>
</body>
</html>